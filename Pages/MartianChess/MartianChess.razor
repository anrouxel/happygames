@page "/martianchess"
@using happygames.Models.MartianChess
@using happygames.Hubs
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.SignalR.Client
@implements IDisposable

<PageTitle>Echec Martien</PageTitle>

@if (isGame && board != null)
{
    <div class="container">
        @for (int y = 0; y < board.getVerticalSize(); y++)
        {
            <div class="row">
                @for (int x = 0; x < board.getHorizontalSize(); x++)
                {
                    string pawn;
                    Coordinate coordinate = new Coordinate(x, y);
                    switch (board.getBoxes()[y, x].getPawn())
                    {
                        case SmallPawn smallPawn:
                            pawn = "P";
                            break;
                        case MediumPawn mediumPawn:
                            pawn = "M";
                            break;
                        case BigPawn bigPawn:
                            pawn = "G";
                            break;
                        default:
                            pawn = "";
                            break;
                    }
                    <div class="col">
                        <RadzenButton Style="height: 50px; width: 100%;" Text=@pawn Click="() => displace(coordinate)"/>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    private HubConnection? hubConnection;
    private string? hubUrl;
    private Board? board;
    private bool isGame;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            string baseUrl = NavigationManager.BaseUri;
            hubUrl = baseUrl.TrimEnd('/') + MartianChessHub.HubUrl;
            hubConnection = new HubConnectionBuilder().WithUrl(hubUrl).Build();
            hubConnection.On<bool>("isGame", isGameSignalR);
            hubConnection.On<Board>("OnBoard", OnBoardSignalR);
            hubConnection.On<string, string>("OnShowError", OnShowError);
            await hubConnection.StartAsync();
        }
        catch (Exception)
        {
            isGame = false;
        }
    }

    public void Dispose()
    {
        hubConnection!.StopAsync();
        hubConnection!.DisposeAsync();
    }

    private void isGameSignalR(bool isGame)
    {
        this.isGame = isGame;
        StateHasChanged();
    }

    private void OnBoardSignalR(Board board)
    {
        Console.WriteLine(board);
        this.board = board;
        StateHasChanged();
    }

    private async Task displace(Coordinate coordinate)
    {
        Console.WriteLine($"{coordinate.getX()}" + " " + $"{coordinate.getY()}");
        await hubConnection!.SendAsync("OnDisplace", coordinate);
    }

    private void OnShowError(string username, string message)
    {
        NotificationMessage notificationMessage = new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = username,
            Detail = message,
            Duration = 4000
        };
        NotificationService.Notify(notificationMessage);
    }
}
